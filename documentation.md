# Полная документация: Анализатор HTTP-логов

## Обзор

Анализатор HTTP-логов - это мощная утилита командной строки, разработанная на языке C, предназначенная для анализа и извлечения статистической информации из лог-файлов HTTP-серверов. Программа использует регулярные выражения для извлечения данных из стандартных и пользовательских форматов логов, поддерживает многопоточную обработку для повышения производительности и предоставляет ряд аналитических функций для анализа данных логов.

## Функциональные возможности

### Поддерживаемые форматы логов

1. **Common Log Format (CLF)** - стандартный формат логов Apache, представленный в виде:
   ```
   %h %l %u %t "%r" %>s %b
   ```
   Пример:
   ```
   192.168.1.1 - - [01/Jan/2023:12:34:56 +0000] "GET /index.html HTTP/1.1" 200 1234
   ```

2. **Combined Log Format** - расширенный формат логов Apache, включающий информацию о Referer и User-Agent:
   ```
   %h %l %u %t "%r" %>s %b "%{Referer}i" "%{User-Agent}i"
   ```
   Пример:
   ```
   192.168.1.1 - - [01/Jan/2023:12:34:56 +0000] "GET /index.html HTTP/1.1" 200 1234 "http://example.com" "Mozilla/5.0"
   ```

3. **Пользовательские форматы логов** - возможность определить собственный формат логов с помощью JSON-конфигурации и регулярных выражений.

### Аналитические функции

1. **Топ N IP-адресов** - вывод N наиболее часто встречающихся IP-адресов в логе.
2. **Топ N URL** - вывод N наиболее часто запрашиваемых URL.
3. **Распределение HTTP-кодов ответа** - статистика по кодам ответа HTTP (200, 404, 500 и т.д.).
4. **Топ N User-Agent** - вывод N наиболее популярных браузеров/клиентов.
5. **Фильтрация** - возможность отфильтровать записи логов по IP-адресу или URL.
6. **Статистика по времени** - количество запросов в определенный временной интервал (почасовая).

### Дополнительные возможности

1. **Многопоточная обработка** - возможность обрабатывать большие лог-файлы, разделяя нагрузку на несколько потоков.
2. **Настраиваемые параметры** - все аналитические функции могут быть настроены через параметры командной строки.
3. **Фильтрация по времени** - возможность анализировать только события в определенном временном интервале.
4. **Расширяемость** - поддержка пользовательских форматов логов через конфигурационные файлы.

## Архитектура и структура кода

### Основные компоненты системы

1. **Основной модуль (main.c)** - обработка аргументов командной строки, инициализация анализатора и вывод результатов.
2. **Модуль анализатора логов (log_analyzer.c, log_analyzer.h)** - основные функции для анализа логов, извлечения данных и сбора статистики.
3. **Модуль конфигурации (config.c, config.h)** - функции для работы с конфигурационными файлами и поддержки пользовательских форматов логов.

### Ключевые структуры данных

#### Структура записи лога (LogEntry)

```c
typedef struct {
    char* ip;
    char* datetime;
    char* method;
    char* url;
    int code;
    long size;
    char* referer;
    char* useragent;
} LogEntry;
```

#### Структура формата лога (LogFormat)

```c
typedef struct {
    char* name;
    char* pattern;
    regex_t regex;
} LogFormat;
```

#### Структура статистики (AnalyzerStats)

```c
typedef struct {
    struct {
        char** ips;
        int* counts;
        int size;
        int capacity;
    } ip_stats;

    struct {
        char** urls;
        int* counts;
        int size;
        int capacity;
    } url_stats;

    int response_codes[600];

    struct {
        char** useragents;
        int* counts;
        int size;
        int capacity;
    } useragent_stats;

    struct {
        time_t start_time;
        time_t end_time;
        int* counts_per_hour;
    } time_stats;

    pthread_mutex_t mutex;
} AnalyzerStats;
```

#### Структура данных потока (ThreadData)

```c
typedef struct {
    FILE* file;
    long start_offset;
    long end_offset;
    LogFormat* format;
    AnalyzerStats* stats;
    char* ip_filter;
    char* url_filter;
    time_t start_time_filter;
    time_t end_time_filter;
} ThreadData;
```

### Алгоритм работы программы

1. Парсинг аргументов командной строки и определение параметров анализа.
2. Инициализация форматов логов (стандартных и пользовательских).
3. Определение формата лога для текущего анализа.
4. Открытие и анализ лог-файла:
   - Разделение файла на части для многопоточной обработки.
   - Запуск потоков для параллельной обработки частей лог-файла.
   - Парсинг каждой строки лога с использованием регулярных выражений.
   - Извлечение данных и обновление статистики (с блокировками для потокобезопасности).
5. Ожидание завершения всех потоков.
6. Отображение собранной статистики в соответствии с запрошенными аналитическими функциями.
7. Очистка ресурсов и завершение программы.

## Использование

### Опции командной строки

| Опция | Описание |
|-------|----------|
| `-f <формат>` | Указать формат лога (common, combined) |
| `-l <файл>` | Указать лог-файл для анализа |
| `-config <файл>` | Указать файл конфигурации для пользовательского формата лога |
| `-topip <n>` | Показать топ N IP-адресов |
| `-topurl <n>` | Показать топ N URL |
| `-topua <n>` | Показать топ N User-Agent |
| `-ip <ip>` | Фильтровать по IP-адресу |
| `-url <url>` | Фильтровать по URL |
| `-time stats` | Включить статистику по времени |
| `-start <дата-время>` | Начальный фильтр времени (формат: YYYY-MM-DD HH:MM:SS) |
| `-end <дата-время>` | Конечный фильтр времени (формат: YYYY-MM-DD HH:MM:SS) |
| `-h` | Показать справку |

### Примеры использования

#### Анализ лог-файла в формате Combined Log Format

```bash
./log_analyzer -f combined -l access.log -topip 10 -topurl 5
```

Эта команда:
- Анализирует лог-файл `access.log` в формате Combined Log Format
- Выводит топ 10 IP-адресов и топ 5 URL

#### Анализ с фильтрацией по времени

```bash
./log_analyzer -f combined -l access.log -time stats -start "2023-10-26 00:00:00" -end "2023-10-26 23:59:59"
```

Эта команда:
- Анализирует лог-файл `access.log` в формате Combined Log Format
- Включает статистику по времени
- Ограничивает анализ записями, созданными в указанный период времени

#### Использование пользовательского формата лога

```bash
./log_analyzer -config custom_format.json -l access.log -topip 10
```

Эта команда:
- Использует пользовательский формат лога, определенный в файле `custom_format.json`
- Анализирует лог-файл `access.log`
- Выводит топ 10 IP-адресов

### Конфигурация пользовательских форматов логов

Пользовательские форматы логов определяются в JSON-файлах. Пример конфигурационного файла:

```json
{
  "log_format": "custom",
  "regex": "^(?<ip>\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}) - - \\[(?<datetime>.*)\\] \"(?<method>\\w+) (?<url>[^ ]*) HTTP/[0-9\\.]+ \" (?<code>\\d+) (?<size>\\d+) \"(?<referer>[^\"]*)\" \"(?<useragent>[^\"]*)\"$",
  "fields": {
    "ip": "ip",
    "datetime": "datetime",
    "method": "method",
    "url": "url",
    "code": "code",
    "size": "size",
    "referer": "referer",
    "useragent": "useragent"
  }
}
```

## Описание API

### Основные функции модуля анализатора логов (log_analyzer.c)

#### Инициализация и настройка

```c
void init_log_formats(LogFormat** formats, int* num_formats);
```
Инициализирует стандартные форматы логов (Common Log Format и Combined Log Format).

```c
void add_log_format(LogFormat** formats, int* num_formats, const char* name, const char* pattern);
```
Добавляет новый формат лога с указанным именем и шаблоном регулярного выражения.

```c
void init_analyzer_stats(AnalyzerStats* stats);
```
Инициализирует структуру статистики анализатора.

#### Парсинг и обработка логов

```c
bool parse_log_entry(char* line, LogFormat* format, LogEntry* entry, RegexMatches* matches);
```
Парсит строку лога с использованием указанного формата и извлекает данные.

```c
void* process_log_chunk(void* arg);
```
Функция потока для обработки части лог-файла.

```c
time_t parse_datetime(const char* datetime);
```
Парсит строку даты и времени в формате лога Apache и преобразует её в time_t.

#### Обновление статистики

```c
void update_ip_stats(AnalyzerStats* stats, const char* ip);
void update_url_stats(AnalyzerStats* stats, const char* url);
void update_response_code_stats(AnalyzerStats* stats, int code);
void update_useragent_stats(AnalyzerStats* stats, const char* useragent);
void update_time_stats(AnalyzerStats* stats, const char* datetime);
```
Функции для обновления различных типов статистики.

#### Вывод результатов

```c
void print_top_n(char** items, int* counts, int size, int n, const char* title);
void print_response_code_stats(int* codes, const char* title);
```
Функции для вывода результатов анализа.

### Основные функции модуля конфигурации (config.c)

```c
void load_log_format_from_json(const char* filename, void (*add_format_callback)(const char*, const char*));
```
Загружает формат лога из JSON-файла и регистрирует его с помощью callback-функции.

## Производительность и оптимизация

### Многопоточность

Программа разделяет лог-файл на несколько частей и обрабатывает каждую часть в отдельном потоке, что значительно повышает производительность на многоядерных системах. Для синхронизации доступа к общей статистике используется мьютекс.

### Оптимизация памяти

1. Динамическое выделение памяти для структур данных с регулярным увеличением размера для снижения количества операций перевыделения.
2. Эффективное представление статистики по кодам ответа в виде массива фиксированного размера.
3. Освобождение всех ресурсов после использования для предотвращения утечек памяти.

### Обработка больших файлов

Программа способна эффективно обрабатывать большие лог-файлы (размером в несколько гигабайт) за счет:
1. Многопоточной обработки.
2. Построчного чтения лог-файла (вместо загрузки всего файла в память).
3. Эффективных структур данных для хранения статистики.

## Обработка ошибок

Программа включает следующие механизмы обработки ошибок:

1. Проверка наличия необходимых аргументов командной строки.
2. Проверка существования и доступности лог-файла.
3. Валидация регулярных выражений для форматов логов.
4. Проверка успешности выделения памяти.
5. Обработка ошибок создания потоков.
6. Корректная обработка некорректных строк в логах.

## Расширение функциональности

### Добавление новых форматов логов

Для добавления поддержки нового формата лога:

1. Создайте JSON-файл конфигурации с описанием формата:
   ```json
   {
     "log_format": "название_формата",
     "regex": "регулярное_выражение_для_парсинга",
     "fields": {
       "поле1": "имя_поля1",
       "поле2": "имя_поля2",
       ...
     }
   }
   ```

2. Укажите файл конфигурации при запуске программы:
   ```bash
   ./log_analyzer -config файл_конфигурации.json -l лог-файл
   ```